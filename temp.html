<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Timetable Editor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to highlight interactive slots */
        body {
            font-family: 'Inter', sans-serif;
        }
        .unalloted-slot {
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .unalloted-slot:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            filter: brightness(1.2);
        }
        .newly-allotted {
            /* Style for slots filled by the user */
            background-color: rgb(191, 219, 254) !important; /* Light blue */
            color: rgb(30, 58, 138) !important;
            font-size: 11px !important;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 flex justify-center">

    <div class="w-full max-w-7xl bg-white shadow-2xl rounded-xl overflow-hidden">
        <header class="p-4 md:p-6 bg-indigo-600 text-white shadow-lg">
            <h1 class="text-3xl font-extrabold mb-1">Timetable Slot Filler</h1>
            <p class="text-indigo-200">Click on any **dark gray** unallotted slot (e.g., P6, E) to add a new subject.</p>
        </header>
        
        <div class="overflow-x-auto p-4 md:p-6">
            <!-- START: User's Provided Timetable HTML -->
            <table align="" border="5px" cellpadding="10" cellspacing="2" width="400" style="border: 10px solid #1f2937; max-width: 100%; background-color: rgb(0, 0, 0);">
                <caption class="t1" style="display: table-caption; margin-top: 5px; color: #1f2937; font-weight: bold; font-size: 1.25rem;">Your Personalized Timetable by Unfugly
                </caption>
                <tbody>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;" rowspan="1">Time</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">08:00 	- 08:50</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">08:50 	- 09:40</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">09:45 	- 10:35</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">10:40 	- 11:30</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">11:35 	- 12:25</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">12:30 	- 01:20</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">01:25 	- 02:15</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">02:20 	- 03:10</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">03:10 	- 04:00</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px;">04:00 	- 04:50</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px; display: none;">04:50 	- 05:30</td>
                        <td rowspan="1" style="width: 120px; height: 8px; background-color: rgb(241, 148, 138); font-size: 10px; max-height: 40px; display: none;">05:30 	- 06:10</td>
                    </tr>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(248, 196, 113); font-size: 10px;">Day 1</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Transforms and Boundary Value Problems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Transforms and Boundary Value Problems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Operating Systems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Operating Systems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">UHV-II: Universal Human Values – Under...</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: To be Alloted</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P6">P6</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P7">P7</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P8">P8</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P9">P9</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P10">P10</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L11">L11</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L12">L12</td>
                    </tr>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(248, 196, 113); font-size: 10px;">Day 2</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P11">P11</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P12/X">P12/X</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P13/X">P13/X</td>
                        <td style="width: 120px; height: 8px; background-color: lightgreen; min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Professional Ethics</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: online</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P15">P15</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">UHV-II: Universal Human Values – Under...</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: To be Alloted</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">UHV-II: Universal Human Values – Under...</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: To be Alloted</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Transforms and Boundary Value Problems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L21">L21</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L22">L22</td>
                    </tr>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(248, 196, 113); font-size: 10px;">Day 3</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Computer Organization and Architecture</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Computer Organization and Architecture</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Transforms and Boundary Value Problems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Advanced Programming Practice</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P26">P26</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P27">P27</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P28">P28</td>
                        <td style="width: 120px; height: 8px; background-color: lightgreen; min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Operating Systems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: TP2-CLS419(A)</span></td>
                        <td style="width: 120px; height: 8px; background-color: lightgreen; min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Operating Systems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: TP2-CLS419(A)</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L31">L31</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L32">L32</td>
                    </tr>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(248, 196, 113); font-size: 10px;">Day 4</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P31">P31</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P32/X">P32/X</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P33/X">P33/X</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P34">P34</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P35">P35</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Advanced Programming Practice</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Advanced Programming Practice</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: E">E</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Computer Organization and Architecture</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L41">L41</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L42">L42</td>
                    </tr>
                    <tr>
                        <td style="width: 120px; height: 8px; background-color: rgb(248, 196, 113); font-size: 10px;">Day 5</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: E">E </td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: E / X">E / X</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Computer Organization and Architecture</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Operating Systems</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(249, 231, 159); min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Advanced Programming Practice</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: LH604</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P46">P46</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P47">P47</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: P48">P48</td>
                        <td style="width: 120px; height: 8px; background-color: lightgreen; min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: TP713</span></td>
                        <td style="width: 120px; height: 8px; background-color: lightgreen; min-width: 90px;" class="replaced-slot"><span style="font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;">Data Structures and Algorithms</span><span style="color: rgb(85, 85, 85); font-size: 0.6em; display: block;">Room: TP713</span></td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L51">L51</td>
                        <td style="width: 120px; height: 8px; background-color: rgb(88, 91, 91); display: none; min-width: 90px; color: rgb(170, 170, 170); font-size: 0.8em;" title="Unrecognized slot: L52">L52</td>
                    </tr>
                </tbody>
            </table>
            <!-- END: User's Provided Timetable HTML -->
        </div>
    </div>

    <!-- Custom Modal for Input -->
    <div id="inputModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden transition-opacity duration-300 items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm m-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <h2 class="text-xl font-bold mb-4 text-indigo-600">Fill Unallotted Slot</h2>
            <p class="mb-4 text-gray-700">Enter the subject and room information.</p>
            
            <label for="subjectInput" class="block text-sm font-medium text-gray-700 mb-1">Subject/Activity Name</label>
            <input type="text" id="subjectInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4 text-gray-900" placeholder="e.g., Data Science Workshop">
            
            <label for="roomInput" class="block text-sm font-medium text-gray-700 mb-1">Room/Location</label>
            <input type="text" id="roomInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-6 text-gray-900" placeholder="e.g., Online / LH201">
            
            <div class="flex justify-end space-x-3">
                <button id="cancelBtn" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition shadow">Cancel</button>
                <button id="saveBtn" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/50">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables & Modal Control ---
        let currentCallback = null;
        let currentCell = null;

        const modal = document.getElementById('inputModal');
        const modalContent = document.getElementById('modalContent');
        const subjectInput = document.getElementById('subjectInput');
        const roomInput = document.getElementById('roomInput');
        const saveBtn = document.getElementById('saveBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        /**
         * Shows the custom input modal.
         * @param {string} initialSubject - The subject to pre-fill (optional).
         * @param {string} initialRoom - The room to pre-fill (optional).
         * @param {function} callback - Function to run on save (receives {subject, room}).
         */
        function showModal(initialSubject, initialRoom, callback) {
            currentCallback = callback;
            subjectInput.value = initialSubject || '';
            roomInput.value = initialRoom || 'To be Alloted'; // Default room text
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'opacity-100');
            modalContent.classList.remove('opacity-0', 'scale-95');
            modalContent.classList.add('opacity-100', 'scale-100');
            subjectInput.focus();
        }

        function hideModal() {
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            modal.classList.remove('opacity-100', 'flex');
            // Allow transition before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            currentCallback = null;
            currentCell = null;
        }

        saveBtn.onclick = () => {
            const subject = subjectInput.value.trim();
            const room = roomInput.value.trim();
            if (currentCallback) {
                currentCallback({ subject, room });
            }
            hideModal();
        };

        cancelBtn.onclick = () => {
            hideModal();
        };

        subjectInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                roomInput.focus();
            }
        };

        roomInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                saveBtn.click();
            }
        };


        // --- Core Timetable Logic ---
        
        /**
         * The function that is called when an unallotted slot is clicked.
         * It opens the modal and handles the saving of new content.
         * @param {Event} event 
         */
        function handleSlotClick(event) {
            currentCell = event.currentTarget;
            
            // 1. Check current content to allow editing
            let initialSubject = '';
            let initialRoom = '';

            // If the cell contains spans, it's already filled/edited. Extract content.
            const subjectSpan = currentCell.querySelector('span:first-child');
            const roomSpan = currentCell.querySelector('span:last-child');
            
            if (subjectSpan) {
                initialSubject = subjectSpan.textContent;
                initialRoom = roomSpan.textContent.replace('Room: ', '');
            } else {
                // Otherwise, it's an original placeholder, use the title for reference
                initialSubject = currentCell.getAttribute('title') || '';
            }

            // 2. Show the modal with extracted/placeholder content
            showModal(initialSubject, initialRoom, (data) => {
                const { subject, room } = data;

                if (subject) {
                    // Update the cell's appearance (change to new allotted style)
                    currentCell.classList.remove('unalloted-slot');
                    currentCell.classList.remove('bg-gray-700'); // Remove the dark color class if added by browser
                    currentCell.classList.add('newly-allotted', 'replaced-slot');
                    
                    // Clear existing content (like P6)
                    currentCell.innerHTML = ''; 

                    // Create the new content structure (Subject Span)
                    const subjectContent = document.createElement('span');
                    subjectContent.textContent = subject;
                    subjectContent.style.cssText = 'font-weight: 600; color: rgb(51, 51, 68); display: block; font-size: 11px;';
                    
                    // Create the new content structure (Room Span)
                    const roomContent = document.createElement('span');
                    roomContent.textContent = `Room: ${room}`;
                    roomContent.style.cssText = 'color: rgb(85, 85, 85); font-size: 0.6em; display: block;';
                    
                    // Append spans to the cell
                    currentCell.appendChild(subjectContent);
                    currentCell.appendChild(roomContent);
                    
                } else {
                    // If the user cleared the input, revert to placeholder
                    currentCell.textContent = currentCell.getAttribute('title') || 'Unallotted';
                    currentCell.classList.remove('newly-allotted', 'replaced-slot');
                    currentCell.classList.add('unalloted-slot');
                    // Resetting background color is tricky due to inline styles, so we keep the initial style
                    currentCell.style.backgroundColor = 'rgb(88, 91, 91)';
                    currentCell.style.color = 'rgb(170, 170, 170)';
                }
            });
        }


        /**
         * Initializes the timetable by identifying and attaching event listeners 
         * to all unallotted slots (those with the dark background color).
         */
        function initializeTimetable() {
            const tableBody = document.querySelector('tbody');
            if (!tableBody) return console.error('Timetable body not found.');

            // Select all TD elements that have the dark gray unallotted background
            // We use the inline style check to be specific to your structure.
            const unallottedSlots = tableBody.querySelectorAll('td[style*="rgb(88, 91, 91)"]');

            unallottedSlots.forEach(slot => {
                // Ensure it's not one of the hidden "L" slots if possible (though they have display:none)
                if (slot.style.display !== 'none') {
                    slot.classList.add('unalloted-slot');
                    slot.onclick = handleSlotClick;
                }
            });

            console.log(`Initialized ${unallottedSlots.length} unallotted slots for editing.`);
        }

        // Run initialization when the page is fully loaded
        window.onload = initializeTimetable;

    </script>
</body>
</html>
